<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.18">
<title>Everything You Never Wanted to Know About Spring Boot 3 AOT</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article">
<div id="header">
<h1>Everything You Never Wanted to Know About Spring Boot 3 AOT</h1>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Hi, Spring fans! Spring Boot 3 is here, and it&#8217;s amazing! If you want to know the broads strokes of what&#8217;s included, check <a href="https://www.youtube.com/watch?v=aUm5WZjh8RA">out this Spring Tips video</a> for a quick rundown. In this installment, however, I want to look at the details of the brand new ahead-of-time (AOT) compilation engine in Spring Boot 3.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I find it&#8217;s useful to understand where we were to appreciate where we are now. Traditional Spring applications have <em>phases</em> that they go through when they&#8217;re run. This isn&#8217;t exactly what&#8217;s happening, but here&#8217;s a simplification of what&#8217;s happening:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ingest</code> - the Spring application starts up and reads in all the sources of configuration. Remember: Spring Framework is a dependency management framework. It needs to know how your various objects are constructed, their lifecycles (constructors, <code>InitializingBean#afterPropertiesSet</code>,<code>@PostConstruct</code>, <code>DisposableBean#destroy</code>, @PreDestroy), etc. It reads the various configuration files from all the <code>@Configuration</code>-annotated classes in your application, through component scanning where Spring discovers classes annotated   with <code>@Component</code>. This component scanning also discovers classes annotated with annotations that themselves are annotated with <code>@Component</code>, like <code>@Service</code>, <code>@Repository</code>, @Controller`, and <code>@RestController</code>. It also reads in configuration from Spring&#8217;s classic XML configuration format. (I don&#8217;t use it, and haven&#8217;t seen it in the wild in more than half a decade, but still&#8230;&#8203;).</p>
</li>
<li>
<p><code>BeanFactory</code> creation with <code>BeanDefinition</code>  instances  - at this point, Spring turns all the various inputs into a metamodel, full of <code>BeanDefinition</code> instances. These <code>BeanDefinition</code> instances describe the objects that will be wired together. They describe the constructors. The properties to be injected. The setters. The annotations. Everything that will be required to describe this object and get it to a valid state so that it may be given to other objects and just generally start doing work. Importantly, at this phase there are no live-fire beans. Nothing opening ports and sockets. Nothing doing disk IO. None of your business logic will be involved at this point.</p>
</li>
<li>
<p><code>bean</code> creation - at this point, Spring will take all the <code>BeanDefinition</code>  objects and create from them actual, live-fire beans. Constructors will be called. Lifecycle methods invoked. Dependencies satisfied. At the conclusion of this phase, you&#8217;ll have an application that&#8217;s ready to serve production traffic. Which is a nice place to be.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_enter_graalvm">Enter GraalVm</h2>
<div class="sectionbody">
<div class="paragraph">
<p>GraalVM is a dropin replacement for OpenJDK. It <em>is</em> OpenJDK, largely. It has a few extra utilities: notably, a polyglot VM, a native image compiler, and a replacement  HotSpot replacement for the JIT (just-in-time) compiler. We could spend all day on these extra mechanisms, but let&#8217;s focus on the <code>native-image</code> compiler. Henceforth, when I say GraalVM, I&#8217;ll be referring to the <code>native-image</code> compiler.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_you_gotta_start_somewhere">You Gotta Start Somewhere&#8230;&#8203;</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To start, as always, we&#8217;ll go to the <a href="https://start.spring.io">Spring Initialzr (start.spring.io)</a>. On 24 November 2022, you&#8217;ll be able to choose the final Spring Boot 3 general release. But as I write this, I need to use Spring Boot 3 SNAPSHOTS. I&#8217;m using Spring Boot 3, Apache Maven, and Java 17. Java 17 is the new baseline for Spring Framework 6 and Spring Boot 3. I&#8217;m also using GraalVM 22.3. If you&#8217;re using the fabulous SDKMAN utility, then you can do the following to get the exact same version of GraalVM that I have on my instance.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">sdk install java 22.3.r17-grl</code></pre>
</div>
</div>
<div class="paragraph">
<p>I&#8217;ve also added a few dependencies. We won&#8217;t really touch on these dependencies in any great length, but they&#8217;ll help us to demonstrate a few concepts, so I&#8217;ve added them.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Web (<code>org.springframework.boot</code> : <code>spring-boot-starter-web</code>)</p>
</li>
<li>
<p>Actuator (<code>org.springframework.boot</code> : <code>spring-boot-starter-actuator</code>)</p>
</li>
<li>
<p>Spring Data JDBC (<code>org.springframework.boot</code> : <code>spring-boot-starter-data-jdbc</code>)</p>
</li>
<li>
<p>H2 (<code>com.h2database</code> : <code>h2</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>And of course I&#8217;ve got a normal Spring Boot entry class, which looks like this. I won&#8217;t add anything to this class. I&#8217;ll be creating new <code>@Configuration</code>-annotated classes in subpackages.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package com.example.aot;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class AotApplication {

	public static void main(String[] args) {
		SpringApplication.run(AotApplication.class, args);
	}

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s look at our first application, a trivial and fairly typical application that - like any other trivial Spring Boot application - works with a database and surfaces an HTTP endpoint. You have seen this before.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package com.example.aot.basics;

import org.springframework.boot.context.event.ApplicationReadyEvent;
import org.springframework.context.ApplicationListener;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.annotation.Id;
import org.springframework.data.repository.CrudRepository;

import java.util.stream.Stream;

@Configuration
class BasicsConfiguration {

	@Bean
	ApplicationListener&lt;ApplicationReadyEvent&gt; basicsApplicationListener(CustomerRepository repository) {
		return event -&gt; repository //
				.saveAll(Stream.of("A", "B", "C").map(name -&gt; new Customer(null, name)).toList()) //
				.forEach(System.out::println);
	}

}

// <b class="conum">(1)</b>
record Customer(@Id Integer id, String name) {
}

// <b class="conum">(2)</b>
interface CustomerRepository extends CrudRepository&lt;Customer, Integer&gt; {

}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>look ma, no Lombok!</p>
</li>
<li>
<p>this is using Spring Data JDBC and you can too!</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>You&#8217;ll need some SQL schema, so add <code>src/main/resources/schema.sql</code> for our SQL interactions, so let&#8217;s have Spring Boot create it for us on startup:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">create table customer
(
    id   serial primary key,
    name varchar(255) not null
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run the main class in your IDE or on the command line in the usual ways:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">mvn -DskipTests spring-boot:run</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see some output on the console. It works. hurray. Moving on, let&#8217;s turn it into a native image, thusly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">mvn -Pnative -DskipTests native:compile</code></pre>
</div>
</div>
<div class="paragraph">
<p>This&#8217;ll take a minute to finish, so now&#8217;s a good time to pour a cup of coffee, or tea. Maybe do a crossword puzzle. Reflect on the poor life choices you&#8217;ve made to get to this point where your JVM applications take around a minute. It&#8217;s a bit dispiriting, isn&#8217;t it? Always remember: good things come to those who wait!</p>
</div>
<div class="paragraph">
<p>You&#8217;ll find the compiled binary in the <code>target</code> directory, named <code>aot</code>. Run it and you&#8217;ll see it starts up in no time at all. Like a lightbulb! And, best part, you&#8217;ll find that it takes very little memory. There are different ways to measure memory, but I find looking at the resident set size to be informative. Here&#8217;s a script I sue to measure this stuff called <code>rss.sh</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">#!/usr/bin/env bash
PID=${1}
RSS=`ps -o rss ${PID} | tail -n1`
RSS=`bc &lt;&lt;&lt; "scale=1; ${RSS}/1024"`
echo "${PID}: ${RSS}M"</code></pre>
</div>
</div>
<div class="paragraph">
<p>It captures the RSS for a given process identifier, scales it to make it easier to parse, then prints it out.  You can find the process identifier for the Spring Boot application in the console, towards the top of the output of the application. Take it and then pass it as the argument for <code>rss.sh</code>, thusly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">./rss.sh &lt;PID&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>I tend to get numbers just south of 100MB. Not bad! Don&#8217;t believe me? How much RAM is your current JVM application taking? I&#8217;d be pleasantly surprised if it was a gigabyte or less! Imagine being able to deploy the same application for 1/10th the memory footprint!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_spring_component_model">The Spring component model</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So, we know the basic stuff&#8217;s working. But Spring&#8217;s got a rich, dynamic, multifaceted component model that can do some amazing things. Let&#8217;s look at some examples, demonstrating a few interesting aspects of the Spring programming model, old and new(-ish) alike.</p>
</div>
<div class="sect2">
<h3 id="_event_listeners">Event Listeners</h3>
<div class="paragraph">
<p>Did you know that Spring has an event bus that you can use to publish and receive events in one component or another? Any component can fire an event (or more), and any component can listen to, consume, these events. There are two ways to consume events: with a bean of type <code>ApplicationListener&lt;ApplicationEvent&gt;</code>, or with the <code>@EventListener</code> annotation.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s a simple example.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package com.example.aot.events;

import org.springframework.boot.context.event.ApplicationReadyEvent;
import org.springframework.boot.web.context.WebServerInitializedEvent;
import org.springframework.context.ApplicationEvent;
import org.springframework.context.ApplicationListener;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.event.EventListener;

@Configuration
class EventsConfiguration {

	// <b class="conum">(1)</b>
	@Bean
	ApplicationListener&lt;WebServerInitializedEvent&gt; webServerInitializedEventApplicationListener() {
		return event -&gt; run("ApplicationListener&lt;WebServerInitializedEvent&gt;", event);
	}

	// <b class="conum">(2)</b>
	@EventListener
	public void eventListener(ApplicationReadyEvent event) {
		run("@EventListener", event);
	}

	private void run(String where, ApplicationEvent are) {
		System.out.println(where + " : " + are);
	}

}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>this is the first more traditional approach: a bean of type <code>ApplicationListener&lt;T extends ApplicationEvent&gt;</code>.</p>
</li>
<li>
<p>this is the newer style, which frees your code of any explicit dependencies on the Spring framework</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This example listens for two unrelated events: <code>WebServerInitializedEvent</code> tells when the embedded webserver has finished being initialized. The <code>ApplicationReadyEvent</code> gets called as late as possible, right before the application handles traffic.</p>
</div>
<div class="paragraph">
<p>These are just a few of the events that Spring and Spring Boot emit as part of the lifecycle of an application.</p>
</div>
</div>
<div class="sect2">
<h3 id="_a_reusable_recipe_for_object_creation">A Reusable Recipe for Object Creation</h3>
<div class="paragraph">
<p>Things are never easy. Sometimes objects require finessing and customization. Sometimes, creating an object becomes more complicated than just a simple constructor. It&#8217;s useful to isolate this construction logic in a single place so that it is reusable. There are at least two patterns that describe this sort  of parameterized construction, besides a constructor:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the fluid builder pattern</p>
</li>
<li>
<p>the factory pattern</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There&#8217;s nothing really to be done to support the first pattern. The second pattern, on the other hand, is well served by the <code>FactoryBean&lt;T&gt;</code>. When you register a class of type <code>FactoryBean&lt;T&gt;</code> in the Spring context, it is the <em>product</em> (an isntance of type <code>T</code>) of that <code>FactoryBean&lt;T&gt;</code>, not the <code>FactoryBean&lt;T&gt;</code> itself, that is registered in the application context and made available for injection. Let&#8217;s look at its use in a trivial example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package com.example.aot.factorybeans;

import org.springframework.beans.factory.FactoryBean;
import org.springframework.boot.context.event.ApplicationReadyEvent;
import org.springframework.context.ApplicationListener;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
class FactoryBeansConfiguration {

	// <b class="conum">(1)</b>
	@Bean
	AnimalFactoryBean animalFactoryBean() {
		return new AnimalFactoryBean(true, false);
	}

	// <b class="conum">(2)</b>
	@Bean
	ApplicationListener&lt;ApplicationReadyEvent&gt; factoryBeanListener(Animal animal) {
		return event -&gt; animal.speak();
	}

}

class AnimalFactoryBean implements FactoryBean&lt;Animal&gt; {

	private final boolean likesYarn, likesFrisbees;

	AnimalFactoryBean(boolean likesYarn, boolean likesFrisbees) {
		this.likesYarn = likesYarn;
		this.likesFrisbees = likesFrisbees;
	}

	@Override
	public Animal getObject() {
		return (this.likesYarn &amp;&amp; !this.likesFrisbees) ? new Cat() : new Dog();
	}

	@Override
	public Class&lt;?&gt; getObjectType() {
		return Animal.class;
	}

}

interface Animal {

	void speak();

}

class Dog implements Animal {

	@Override
	public void speak() {
		System.out.println("woof");
	}

}

class Cat implements Animal {

	@Override
	public void speak() {
		System.out.println("meow");
	}

}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>the <code>AnimalFactoryBean</code> produces an object of type <code>Animal</code>. But which? Well it depends on the parameters fed into the <code>FactoryBean</code>.</p>
</li>
<li>
<p>the client code injects the <code>Animal</code>, ignorant of the construction logic.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_scopes">Scopes</h3>
<div class="paragraph">
<p>Beans in Spring have a lifecycle that describes the lifetime of a given object. Unless you specify something specifically, the default scope is <code>singleton</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>singleton</code> - a bean is created when the application starts up and is destroyed when the application shuts down. If a bean has mutable state, then that instance will be visible to all other beans in any other scopes. It&#8217;s global.</p>
</li>
<li>
<p><code>session</code> - a bean is created anew for each new HTTP Session. Each user with an HTTP session will have their own instance of the bean. Changes won&#8217;t be visible to other clients.</p>
</li>
<li>
<p><code>web</code> - each new HTTP request gets a new instance of the bean.</p>
</li>
<li>
<p><code>thread</code> - beans are unique to each thread. Sort of like a <code>ThreadLocal</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>And this mechanism is pluggable, too, so implementors may provide their own scopes, as well. Spring does this across the portfolio, in projects like Spring Web Flow and Spring Batch. You&#8217;ll also see it in various third party projects like the Spring support for the Flowable workflow engine.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">package com.example.aot.scopes;

import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Lazy;
import org.springframework.stereotype.Component;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.context.annotation.RequestScope;

import java.util.UUID;

@Configuration
class ScopesConfiguration {

}

// <b class="conum">(1)</b>
@Component
@RequestScope
class RequestContext {

	private final String uuid = UUID.randomUUID().toString(); // <b class="conum">(2)</b>

	public String getUuid() {
		return uuid;
	}

}

@RestController
class ContextHttpController {

	private final RequestContext context;

	// <b class="conum">(3)</b>
	ContextHttpController(RequestContext context) {
		this.context = context;
	}

	@GetMapping("/scopes/context")
	String uuid() {
		return this.context.getUuid();
	}

}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>this bean is a <code>request</code> scoped, so it&#8217;ll be created anew for each new incoming HTTP request.</p>
</li>
<li>
<p>this request-scoped bean should be different across different HTTP requests, but the same for successive accesses during the same HTTP request.</p>
</li>
<li>
<p>Spring is giving us a proxy, which won&#8217;t be initialized with real values until the bean starts its lifecycle, bound to whatever externalities govern them.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Try it out by accessing <code><a href="http://localhost:8080/scopes/context" class="bare">http://localhost:8080/scopes/context</a></code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_qualifiers">Qualifiers</h3>
<div class="paragraph">
<p>Qualifiers are conceptually very simple: given two types with the same interface, how does Spring choose which to inject in a given place. The answer is that we <em>qualify</em> the bean we&#8217;d like.</p>
</div>
<div class="paragraph">
<p>Suppose we&#8217;re trying to build two applications that work with two competing mobile phone marketplace implementations, like the Apple AppStore and Android&#8217;s Play store.</p>
</div>
<div class="paragraph">
<p>We might model them with an interface, which we&#8217;re calling <code>MobileMarketplace</code>. In this example, we have two implementations of that interface, and we&#8217;ve used the <code>@Qualifier</code> annotation (and a <code>String</code> that we provide to distinguish one from the other) on both the bean itself and the place where the bean is injected to. As long as the <code>String</code> in the annotation matches, then the right implementation will be injected. This mechanism even goes a bit further:  you can put <code>@Qualifier</code> on a custom annotation of your own, and then use that annotation instead of <code>@Qualifier</code> directly on the various implementations. This helps you enforce an ubiquitous language. Let&#8217;s look at an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package com.example.aot.qualifiers;

import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.boot.context.event.ApplicationReadyEvent;
import org.springframework.context.ApplicationListener;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.stereotype.Service;

import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.util.Map;

@Configuration
class QualifiersConfiguration {

	// <b class="conum">(1)</b>
	@Bean
	ApplicationListener&lt;ApplicationReadyEvent&gt; android(@Android MobileMarketplace mobileMarketplace) {
		return event -&gt; System.out.println(mobileMarketplace.getClass().toString());
	}

	// <b class="conum">(2)</b>
	@Bean
	ApplicationListener&lt;ApplicationReadyEvent&gt; ios(@Apple MobileMarketplace mobileMarketplace) {
		return event -&gt; System.out.println(mobileMarketplace.getClass().toString());
	}

	// <b class="conum">(3)</b>
	@Bean
	ApplicationListener&lt;ApplicationReadyEvent&gt; mobileMarketplaceListener(
			Map&lt;String, MobileMarketplace&gt; mobileMarketplaces) {
		return event -&gt; mobileMarketplaces
				.forEach((key, bean) -&gt; System.out.println(key + '=' + bean.getClass().getName()));
	}

}

// <b class="conum">(4)</b>
@Retention(RetentionPolicy.RUNTIME)
@Qualifier("ios")
@interface Apple {

}

@Retention(RetentionPolicy.RUNTIME)
@Qualifier("android")
@interface Android {

}

interface MobileMarketplace {

}

// <b class="conum">(5)</b>
@Service
@Qualifier("ios")
class AppStore implements MobileMarketplace {

}

@Service
@Qualifier("android")
class PlayStore implements MobileMarketplace {

}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>this bean uses the <code>android</code> implementation</p>
</li>
<li>
<p>this bean uses the <code>apple</code> implementation</p>
</li>
<li>
<p>can&#8217;t decide? Just inject a <code>Map&lt;String,T&gt;</code>, where <code>T</code> is the type you&#8217;re looking for. Spring will provide a map of bean names to bean types.</p>
</li>
<li>
<p>here we create a meta annotation.</p>
</li>
<li>
<p>here we create an implementation of the interface</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>I love that I can define a bean&#8217;s qualifier using the <code>@Qualifier</code> annotation directly, and then inject it into a particular site using the meta annotation. Or, vice versa. Spring doesn&#8217;t care. It just works.</p>
</div>
</div>
<div class="sect2">
<h3 id="_properties">Properties</h3>
<div class="paragraph">
<p>Spring Framework provides the <code>Environment</code> abstraction, which is basically a mapping between a <code>String</code> key and a <code>String</code> value. How those values are resolved is pluggable, through <code>PropertyResolver</code> instances. Spring Boot can then take values in the <code>Environment</code> and map them to objects, either via setters or via the constructors of the objects. Here&#8217;s an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package com.example.aot.properties;

import org.springframework.boot.context.event.ApplicationReadyEvent;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.context.ApplicationListener;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
@EnableConfigurationProperties(DemoProperties.class)
class PropertiesConfiguration {

	@Bean
	ApplicationListener&lt;ApplicationReadyEvent&gt; propertiesApplicationListener( // <b class="conum">(1)</b>
			DemoProperties properties) {
		return args -&gt; System.out.println("the name is " + properties.name());
	}

}

// <b class="conum">(2)</b>
@ConfigurationProperties(prefix = "bootiful")
record DemoProperties(String name) {
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Here, we&#8217;re injecting a Java object called <code>DemoProperties</code>, to which properties starting with <code>bootiful</code> are bound</p>
</li>
<li>
<p>the <code>@ConfigurationProperties</code> annotation wires Spring to inject properties on to an instance of <code>DemoProperties</code>.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_see_how_they_run">See How They Run</h3>
<div class="paragraph">
<p>You can compile and run all this code in the usual way as a GraalVM native image.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">mvn -DskipTests native:compile &amp;&amp; ./target/aot</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run the application and you should see all the output from the previous examples, as expected. The best part? It&#8217;ll have started in no time at all, and be a far sight smaller as a binary and as a process occupying RAM. You can use the script we introduced above to measure the process' Resident Set Size (RSS).</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_detecting_that_youre_in_a_native_image">Detecting that you&#8217;re in a Native Image</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Sometimes, hopefully not often, but sometimes you&#8217;ll want to know whether your code is running in a native image context. This is useful because, as good as Spring&#8217;s AOT engine is, we can&#8217;t make it work perfectly in every situation, short of reviewing every line of code ever written. There are oddities that arise from working in a GraalVM native image, and it&#8217;s important to be aware of those.</p>
</div>
<div class="paragraph">
<p>There is, mercifully, one useful System property that you can use here: <code>org.graalvm.nativeimage.imagecode</code>.  We&#8217;ve encapsulated that check in <code>NativeDetector.inNativeImage()</code>. Here it is in action.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package com.example.aot.detection;

import org.springframework.boot.context.event.ApplicationReadyEvent;
import org.springframework.context.ApplicationListener;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.core.NativeDetector;

@Configuration
class DetectionConfiguration {

	@Bean
	ApplicationListener&lt;ApplicationReadyEvent&gt; detectionListener() {
		return args -&gt; System.out.println("is native image? " + NativeDetector.inNativeImage());
	}

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run it on the JRE and it&#8217;ll return <code>false</code>. Run it in a GraalVM native image, and it&#8217;ll return <code>true</code>.</p>
</div>
<div class="paragraph">
<p>My first instinct when I learned about that property was to wrap it in a <code>Condition</code> object, and then use <code>@Conditional</code> to call that <code>Condition</code>, and thus make beans available in the Spring <code>BeanFactory</code> <em>conditionally</em>. I tried it, and it didn&#8217;t work. Here&#8217;s why.</p>
</div>
<div class="paragraph">
<p>Recall our discussion around the <em>phases</em> of a Spring Boot application. It starts up, <em>ingests</em> all the configuration, then creates a meta model representation of the beans (`BeanDefinition`s). Then, finally, it creates all those beans out of those `BeanDefinition`s.</p>
</div>
<div class="paragraph">
<p>In an AOT application intended for GraalVM native image compilation, Spring creates a <code>BeanFactory</code> with <code>BeanDefinition</code> and then stops there. It lets code inspect the various beans in the <code>BeanFactory</code> and then that code writes out an optimized version of the <code>BeanFactory</code>, skipping all the ingest and going straight to the live beans, for use in the GraalVM native image context. An important part of this is that it does this _only for the beans that are present in the <code>BeanFactory</code> during compilation.</p>
</div>
<div class="paragraph">
<p>There are two things that can dynamically change the beans in a given <code>BeanFactory</code>: conditionals, and profiles. I&#8217;d strongly urge you to avoid using profiles, and a handful of conditionals, if you intend to go to a GraalVM native image.</p>
</div>
<div class="paragraph">
<p>Profiles only work if you activate the profile during compilation. The profiles must be evaluated at compile time. Otherwise, beans not in an active profile won won&#8217;t be present in the native image heap and thus can&#8217;t be activated at runtime.</p>
</div>
<div class="paragraph">
<p>Conditions are evaluated at compile time. The conditions that are invariant at compilation time and runtime - like <code>@ConditionalOnClass</code> and <code>@ConditionalOnProperty</code> - work just fine in the native world: the classes present at compile time are by definition the classes present at runtime. Some conditions depend on ambient state, however, like whether you&#8217;re running in a Kubernetes cluster (<code>@ConditionalOnCloudPlatform(Kubernetes)</code>). Avoid these, unless you plan on compiling your code in a Kubernetes cluster.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_application_migration">Application Migration</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>[on camera]</p>
</li>
<li>
<p>everything works so far, and that&#8217;s certainly our goal, that the vast majority of Spring applications have a path to upgrade to Spring Boot 3 and then enjoy the benefits of compilation as a GraalVM native image. But, sometimes things don&#8217;t work as expected.</p>
</li>
<li>
<p>Sometimes they don&#8217;t work because one of the libraries on the class path or indeed your code itself has done something to run afoul of the aforementioned cases where you&#8217;ll need to furnish configuration <code>.json</code> files</p>
</li>
<li>
<p>[ time :: video to express the passage of time]</p>
</li>
<li>
<p>The error messages are pretty helpful, but the cycle time of compiling and running the application, getting a compiler error, making a change, then repeating can be tedious, especially when 30s or longer compiler times and long reset cycles are involved!</p>
</li>
<li>
<p>[on camera]</p>
</li>
<li>
<p>once you know what configuration your application will need, it&#8217;s pretty straightforward to then craft the hints using the Java API. There&#8217;s a pretty good way to get a lot of this work done for you: run the <strong>java agent</strong>.</p>
</li>
<li>
<p>You can run the program and get it to tell you what things were reflected on by running the app on the jvm with <code>-Dagent=true</code> when running the app with maven (try <code>spring-boot:run</code>). This will dump out config files in the <code>target/native/agent-output</code> directory</p>
</li>
<li>
<p><strong>Demo</strong> [<code>migration</code> or <code>reflection</code>]</p>
</li>
<li>
<p>create a <code>data.csv</code> with the following contents:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>1,Madhura
2,Yuxin
3,Phil
4,Violetta
5,Stéphane
6,Jürgen
7,Dr. Syer
8,Josh
9,Marcin
10,Candice</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>write a program that loads some CSV data from the classpath, then uses it to create some <code>Customer</code> data and turn it into JSON to be logged on the  console using <code>ObjectMapper</code> for easy debugging.</p>
</li>
<li>
<p>this will require support for both <code>reflection-config.json</code> and <code>resources-config.json</code>.</p>
</li>
<li>
<p>contribute the java agent to the build:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&lt;configuration&gt;
  &lt;jvmArguments&gt;
   -agentlib:native-image-agent=config-output-dir=target/native-image
&lt;/jvmArguments&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>then run it thusly</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>rm -rf target

./mvnw -DskipTests clean package spring-boot:run</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>have it tell us what kind of hints we&#8217;ll need. Then well craft our first set of hints using the <code>RuntimeHintsRegistrar `and `RegisterforBinding</code></p>
</li>
<li>
<p>the <code>RuntimeHintsRegistrar</code> is a convenient callback that you can easily declare in any <code>@Configuration</code> class with the <code>@ImportRuntimeHints(Class&lt;?&gt;)</code> annotation or via the <code>aot.factories</code> file.</p>
</li>
<li>
<p>for a lot of developers, these two tools - the Java agent and hints - may be enough to get the job done. This is hopefully as much as most application developers will need to know.</p>
</li>
<li>
<p>things get more interesting when you start to imagine infrastructure level concerns, and when you start looking at  purpose-built frameworks built on top of Spring Boot. Let&#8217;s put on our infrastructure hats here and look at some of the meta model programming that Spring has supported since day 1, and how this new AOT compilation phase interacts with all that.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_processing_the_bean_factory">Processing the Bean Factory</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We&#8217;ve talked about the <code>BeanFactory</code>. It&#8217;s basically a container, an aggregation, of all the beans in your application. In earlier sections we saw that the beans in the <code>BeanFactory</code> are created as <code>BeanDefinition</code> instances. These `BeanDefinition`s are the metamodel representation of your object graph. They describe all the dependencies, constructors, annotations, fields, etc., related to your bean instances.</p>
</div>
<div class="paragraph">
<p>Spring makes it trivial to act on those collection of <code>BeanDefinition</code> instances through callback interfaces that are evaluated at compile time (AOT) and runtime (JRE). The <code>BeanFactoryPostProcessor</code> is a callback interface that lets us have access to the <code>BeanFactory</code> and to manipulate the <code>BeanDefinition</code> instances. We can regiser new ones, update existing ones, or even remove them in this interface and in other, more specific subclasses of this interface. The <code>BeanFactory</code> is not fixed at this point. Various Spring projects use this fact to great effect. Before we turned the Spring Cloud project into an umbrealla project that included a ton of different libraries to make working with microservices easier, its sole function was to make it easy for Spring Boot appliations deployed to a Platform-as-a-Service (PaaS) like Cloud Foundry or Heroku to connect to managed infrastructure like a database or a message queue. It did this by analuzing the <code>BeanFactory</code>, identifying infrastructure-related beans like <code>javax.sql.DataSource</code>, and then replacing them with a new bean of an identical interface, but with a connection pointing to the managed infrastructure identified by environment variables in the process space of the running application. So, you write an application using a <code>DataSource</code> talking to an embedded H2 instance on your loccal machine, but when you deploy it, this <code>BeanFactoryPostProcessor</code> identifies connection strings in environment variables in the process space for the application and uses that to create a proper <code>DataSource</code> talking to that managed infrastructure, presumably on another host and port. And this was all transprent to the user, which is what we want.</p>
</div>
<div class="paragraph">
<p>The <code>BeanFactoryPostProcessor</code> is a great place to see <em>everything</em> in the <code>BeanFactory</code> all in one place when the application starts up.</p>
</div>
<div class="paragraph">
<p>the <code>BeanFactoryInitializationAotProcessor</code> is a new itnerface that is sort of a peer t the <code>BeanFactoryPostProcessor</code>. It runs at compile time, and you have basically the same contract: you can choose to contribute hints (or even do code-generation) whuile analyzing the `BeanDefinition`s in the application.</p>
</div>
<div class="paragraph">
<p>It&#8217;s important that you work only in terms of the <code>BeanDefinition</code> instances and bean names, in botht hese interfaces. Remember, at this point Spring hasn&#8217;t created any of theb eans. So, while you&#8217;ll be able to call <code>BeanFactory#getBean(String)</code>, it&#8217;ll force  Spring to eagerly initialize the object, calling the constructor and the methods and so on before the bean is ready. Don&#8217;t do this - it&#8217;ll really screw things up!</p>
</div>
<div class="paragraph">
<p>Let&#8217;s look a trivial example. We&#8217;ll write a <code>BeanFactoryPostProcessor</code> that analyzes programmatically registers a new <code>BeanDefinition</code> in the application context. Would you ever nee dto do this? No. but it&#8217;s hopefully illustrative. We&#8217;ll use a subclass of <code>BeanFactoryPostProcessor</code> called <code>BeanDefinitionRegistryPostProcessor</code>, which gives us a <code>BeanFactory</code> downcast to a specific subtype that supports programatically registering new beans. The trouble is that this bean we&#8217;ll register is going to require some reflection usign the Jackson JSON API, so well need to also register a GraalVM hint for it using a <code>BeanFactoryInitializationAotProcessor</code> contribution.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package com.example.aot.bfpp;

import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.SneakyThrows;
import org.springframework.aot.hint.MemberCategory;
import org.springframework.beans.BeansException;
import org.springframework.beans.factory.aot.BeanFactoryInitializationAotContribution;
import org.springframework.beans.factory.aot.BeanFactoryInitializationAotProcessor;
import org.springframework.beans.factory.config.ConfigurableListableBeanFactory;
import org.springframework.beans.factory.support.BeanDefinitionBuilder;
import org.springframework.beans.factory.support.BeanDefinitionRegistry;
import org.springframework.beans.factory.support.BeanDefinitionRegistryPostProcessor;
import org.springframework.boot.context.event.ApplicationReadyEvent;
import org.springframework.context.ApplicationListener;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.List;
import java.util.UUID;

import static com.example.aot.bfpp.BfppConfiguration.BEAN_NAME;

@Configuration
class BfppConfiguration {

	// <b class="conum">(1)</b>
	static String BEAN_NAME = "myBfppListener";

	// <b class="conum">(2)</b>
	@Bean
	static ListenerBeanFactoryPostProcessor listenerBeanFactoryPostProcessor() {
		return new ListenerBeanFactoryPostProcessor();
	}

	@Bean
	static ListenerBeanFactoryInitializationAotProcessor listenerBeanFactoryInitializationAotProcessor() {
		return new ListenerBeanFactoryInitializationAotProcessor();
	}

}

// <b class="conum">(3)</b>
class Listener implements ApplicationListener&lt;ApplicationReadyEvent&gt; {

	private final ObjectMapper objectMapper;

	Listener(ObjectMapper objectMapper) {
		this.objectMapper = objectMapper;
	}

	@Override
	@SneakyThrows
	public void onApplicationEvent(ApplicationReadyEvent event) {
		var products = List.of(new Product(UUID.randomUUID().toString()), new Product(UUID.randomUUID().toString()));
		for (var p : products)
			System.out.println(objectMapper.writeValueAsString(p));
	}

}

record Product(String sku) {
}

// <b class="conum">(4)</b>
class ListenerBeanFactoryPostProcessor implements BeanDefinitionRegistryPostProcessor {

	@Override
	public void postProcessBeanFactory(ConfigurableListableBeanFactory bf) throws BeansException {
	}

	@Override
	public void postProcessBeanDefinitionRegistry(BeanDefinitionRegistry registry) throws BeansException {

		if (!registry.containsBeanDefinition(BEAN_NAME))
			registry.registerBeanDefinition(BEAN_NAME,
					BeanDefinitionBuilder.rootBeanDefinition("com.example.aot.bfpp.Listener").getBeanDefinition());

	}

}

// <b class="conum">(5)</b>
class ListenerBeanFactoryInitializationAotProcessor implements BeanFactoryInitializationAotProcessor {

	@Override
	public BeanFactoryInitializationAotContribution processAheadOfTime(ConfigurableListableBeanFactory bf) {

		if (bf.containsBeanDefinition(BEAN_NAME)) {
			return (ctx, code) -&gt; {
				var hints = ctx.getRuntimeHints();
				hints.reflection().registerType(Product.class, MemberCategory.values());
			};
		}
		return null;
	}

}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>were going to work with the same bean both at compile time and at runtime. So, I&#8217;ve stashed a variable with the name of the bean here for access from both interfaces at both phases</p>
</li>
<li>
<p>Note that the bean definitions here are registered with the <code>static</code> keyword. Spring will involve these beans very early in the lifecycle of the application context. It won&#8217;t have any livefire beans except for these very early beans. So, we use <code>static</code> to avoid depending on anything from the <code>BeanFactory</code>. And don&#8217;t force Spring to construct the <code>@Configuration</code> class containing the <code>@Bean</code> registration methods, too.</p>
</li>
<li>
<p>the <code>Listener</code> is a trivla <code>ApplicationListener</code> that, wehn run, will iterate over a collection of dummy DTOs and print them out using Jackson for JSON serialization. This serialization involves reflection, for wihch we&#8217;ll need to furnish hints.</p>
</li>
<li>
<p>the first callback, the <code>ListenerBeanFactoryPostProcessor</code>, programatically registers a new <code>BeanDefinition</code> of type <code>Listener</code> if a bean of the name we&#8217;ve specified in the variable doesn&#8217;t already exist in the context. This object runs at runtime, in both the JRE and the AOT application. Here were changing, molding, the <code>BeanFactory</code>.</p>
</li>
<li>
<p>when we compile the application using the AOT engine, intending to biold a graalvm native image, Spring Boot will aso run the the <code>ListenerBeeanFactoryInitializationAotProcessor</code>, which - knoiwing that we&#8217;ll eventually register a <code>Listener</code> bean - furnishes the requisite hints to make the JSON serialization of the <code>Product</code> records work.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>These two itnerfaces work well together. They complement each other. The <code>BeanFactory</code> is the lowest level at which I&#8217;d write code. I don&#8217;t want to write code in terms of the <code>BeanFactory</code> if i can avoid it. It is, as I said, the promoridal ooze of your running application. Its the suggestion, the insinuation, the allusion to a valid working application. But it&#8217;s not a working application. That comes only after those <code>BeanDefinition</code> instances are turned into valid objects. that comes next.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_processing_beans">Processing Beans</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If the <code>BeanFactory</code> is to meta for you, then you can still do interesting things at the next rung in the abstaction ladder, working with beans directly, both before they&#8217;ve been initialized and after.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>[ beans-evolution :: animation of a bean moving from primordial soup to live-beans. 4 columns. In the first column, <code>BeanFactoryInitializationAotProcessor</code>. In the second column, <code>BeanRegistrationAotProcessor</code> In the third column is a bubbling cauldron of lava (with <code>BeanDefinition`s and `BeanFactoryPostProcessors</code> floating about). In the fourth column is regular beans. Show the beans going from the 1st to 4th column in this animation ]</p>
</li>
<li>
<p>working on a bean by bean basis can be very powerful. If you want to work with actual, live-fire beans, you can use Spring&#8217;s <code>BeanPostProcessor</code>. This interface puts you in a position to act-on, to transform, objects before they&#8217;re finally live and handling logic.</p>
</li>
<li>
<p>this is great for infrastructure code, such as frameworks, where you need to note or retain or observe references to objects of a given shape. What shape? Well, anything, really! Objects that have a certain marker interface. Objects that have a certain annotation. Whatever you want, and whatever you could decide given reflection methods.</p>
</li>
<li>
<p>lets look at an example that creates proxies for objects with an annotation, <code>@Logged</code>, logging out any method invocations on those beans.</p>
</li>
<li>
<p>I implement this proxy with Spring&#8217;s <code>ProxyFactory</code>, which makes it trivial to use the <em>proxy</em> design pattern.</p>
</li>
<li>
<p>A proxy, in its most general form, is a class functioning as an interface to something else</p>
</li>
<li>
<p>Spring uses proxies to handle things like declarative transaction management, auditing, security, logging, concurrency, etc. there a great way to <em>decorate</em> an existing object with cross-cutting concerns, like starting and committing a transaction before and after a method invocation. Spring uses them all over the place, for things like <code>@Transactional</code>, <code>@Scheduled</code>, <code>@Async</code>, <code>@Authorized</code>, and countless more.</p>
</li>
<li>
<p>There are two types of proxies: cglib and JDK proxies.</p>
</li>
<li>
<p>JDK proxies are built using the <code>InvocationHandler</code> API. They make it trivial to create an object that implements an interface type of your choice and then forwards the actual work to a concrete instance of your choice. In this case, the word <code>interface</code>  used in the description above is quite literally a Java <code>interface</code> type.</p>
</li>
<li>
<p>but what if the contract the surface area, the <em>interface</em> of your class isn&#8217;t a Java interface? What if it&#8217;s a concrete class for which it makes little sense to extract out a separate Java interface? JDK proxies require an interface, and they were the only thing supported in Spring until Spring Framework 1.1.</p>
</li>
<li>
<p>I can&#8217;t be sure, but I suspect this is one of the reasons so much of the early literature suggests using interfaces with Spring beans, and why you&#8217;d see things like <code>FooService</code> and <code>DefaultFooService</code> or <code>FooService</code> and <code>FooServiceImpl</code> or whatever. Nowadays that&#8217;s an anti-pattern, and highly discouraged, <em>unless</em> you actually plan to have more than one implementation of <code>FooService</code>. That is, suppose you&#8217;re implementing a <code>AppStore</code> interface, and you might have one version of the interface for iOS and another for Android. Avoid the knee-jerk reaction to create an interface for an object that has the same shape as the object. It only complicates things.</p>
</li>
<li>
<p>Spring supports concrete proxies, too, using CGLIB. CGLIB is used to dynamically generate the code to subclass an existing type. The constraint, thus, is that the type be subclass-able. So, beware things like <code>final</code> and <code>sealed</code>.</p>
</li>
<li>
<p>Spring&#8217;s concrete proxies are unique to Spring. You&#8217;re using them every time you use a <code>@Configuration</code> class! They&#8217;re <strong>everywhere.</strong></p>
</li>
<li>
<p>Naturally, creating a dynamic subclass of a given type, registering it in the <code>ClassLoader</code> and then swapping out your instance for the instance that delegates to yours implies a lot of funny business that we&#8217;ll need to account for everything at compile time in an AOT context.</p>
</li>
<li>
<p>Mercifully, Spring can do a lot of this for us. Let&#8217;s take a look at an example.</p>
</li>
<li>
<p><strong>Demo</strong> [<code>beanpostprocessors.proxies</code>]</p>
</li>
<li>
<p>look at the code <code>LoggedBeanPostProcessor</code></p>
</li>
<li>
<p>Note that we&#8217;re using a <code>SmartInstantiationAwareBeanPostProcessor</code>, which is a subclass of <code>BeanPostProcessor</code> with an extra method <code>determineBeanType</code> that gives Spring some insight about the proxy-nature of the returned bean.</p>
</li>
<li>
<p>In this example, we&#8217;re using the cohesive design of Springs AOT support to transparently create proxies that just work. If we&#8217;ve done our job right and you&#8217;ve written your code to leverage the right interfaces, then you can trust Spring to do the right thing for CGLIB proxies.</p>
</li>
<li>
<p>Sometimes, however, you need to intervene and explicitly furnish hints for the things you do at runtime. If you&#8217;re using JDK proxies, then you can explicitly register hints for that with <code>ProxyHints</code>  registrar.</p>
</li>
<li>
<p>You might also have stuff you want to do at runtime that requires upfront, compile-time processing. Code-generation is one of the most powerful dimensions of Spring&#8217;s AOT engine. We use it all over the place in Spring Framework 6!</p>
</li>
<li>
<p>Let&#8217;s look at a simple example. This time we&#8217;ll revisit the code generation to register a Spring Boot Actuator endpoint of type <code>CompilationEndpoint</code>, which we&#8217;re just making up for this example. It&#8217;ll contain information captured <em>at compile-time</em>, like the time and directory in which the code was compiled.</p>
</li>
<li>
<p><strong>Demo</strong> (<code>beanpostprocessors.codegen</code>)</p>
</li>
<li>
<p>Code generation using Java poet to new-up a new bean</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_testing">Testing</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>[on camera]</p>
</li>
<li>
<p>testing is an incredibly important part of the story. The good news is, we&#8217;ve done a ton of work to make testing <strong>just work</strong> in a native image context. you can run a maven build or a Gradle build in native mode and you&#8217;ll get two output artifacts: one for tests, one for the production code. Fair warning tho! This&#8217;ll make the compilation take twice as long! That could be a few minutes.</p>
</li>
<li>
<p>lets look at some examples of tests:</p>
</li>
<li>
<p><strong>Demo</strong></p>
</li>
<li>
<p>Spring Boot tests</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package com.example.aot.basics;

import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;

@SpringBootTest(properties = "spring.main.web-application-type=none")
class CustomerRepositoryTest {

    private final CustomerRepository repository;

    CustomerRepositoryTest(@Autowired CustomerRepository repository) {
        this.repository = repository;
    }

    @Test
    void save() throws Exception {
        var saved = this.repository.save(new Customer(null, "Jürgen")) ;
        Assertions.assertNotNull(saved.id() );
    }
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>run with the <code>nativeTest</code> Maven profile, e.g.:  `mvn  -PnativeTest,native clean package  &amp;&amp; ./target/aot      `</p>
</li>
<li>
<p>there&#8217;s a new binary in the <code>target</code> directory called <code>native-tests</code></p>
</li>
<li>
<p>show how you can write tests things like the predicates themselves with <code>RuntimeHintsPredicates</code>:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">class MigrationsConfigurationTest {

    @Test
    void hints() {
        var runtimeHints = new RuntimeHints();
        var registrar = new MigrationsConfiguration.MigrationsRuntimeHintsRegistrar();
        var classLoader = getClass().getClassLoader();
        registrar.registerHints(runtimeHints, classLoader);
        assertThat(RuntimeHintsPredicates.resource().forResource("data.csv")).accepts(runtimeHints);
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_a_note_on_compile_times">a note on compile times</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You know. I love GraalVM, but one thing that can be a real kick in the pants are the wait-times. I get <em>why</em> it&#8217;s happening. It&#8217;s not hard to understand. GraalVm does a <em>lot</em> of work - doing a full analysis of our code and all the code on the classpath. it&#8217;s no wonder that it takes as much memory and time as it does. And it has already improved <em>dramatically</em> even since I first started using it in earnest less than three years ago. It&#8217;s a marvelous piece of software. But those compile times are tedious. They interrupt my sense of flow. And it&#8217;s almost a curse that they&#8217;ve improved as much as they have, because the compile times are now fast enough hat you don&#8217;t have time to go pour a cup of coffeee or eat a cup of yogurt, but slow enough that you feel like you&#8217;re being interrupted. Youre being kicked out of 'the zone'. This reminds me of that classic XKCD cartoon, which I suspect referred to large C and C++ applications of the day. Java and Go and other more modern languages have mercifully quick compilation times. In this one sense, it feels like graalvm has taken us a step backwards. I kick off a compile and my mind wanders. i&#8217;ve been doing so many of these that now I&#8217;m starting to hear elevator music when I do a compile! Don&#8217;t you hear elevator music? So I filed an issue. I want everyone else to hear elevator music, too. So I asked. It doesn&#8217;t hurt to ask. I went to the official graalvm project and I asked. it seemed to resonate with people. one person even suggested which elevator music we should use. I love it! And, fabian nipehaus - of the official graalvm team at oracle, a PhD - a DOCTOR, like Drs. Seus, Syer, Strange, Who, and Subramaniam - responded with a promising prototype. I love this prototype. He even had it print out some ascii art so that peoplewould have something to look at. i was sad, to say the least, to see that he didn&#8217;t think this would be accepted, if for no other reason than because of the copyrighted music. Dang! oh well. Hope <em>springs</em> eternal.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We&#8217;ve come a long way! When I started covering Spring Native (the predecessor to what would eventually become Spring Framework 6&#8217;s AOT engine) in 2020, a build took <em>10 minutes</em> and only worked for the smallest and most specific scenarios. Now, here we are in 2022 and I can all but effortlessly get a Spring app working in a GraalVM native image context in less than a minute.
- the performance and memory usage implications are hard to ignore, and I think the inertia required to make the move to AOT will be become easier and easier to obtain in the next days, weeks, months and years, as the community embraces Spring&#8217;s newfound AOT support.
- I hope this video makes it easier for everyone, application and framework developers alike, to leverage spring boot 3 and spring framework 6.
- obviously, you won&#8217;t be starved for examples if you need guidance in implementing this stuff in your own code.
- Just look for pointers to types like <code>RuntimeHintsRegistrar</code>, <code>BeanRegistrationAotProcessor</code>, and <code>BeanFactoryInitializationAotProcessor</code> in the Spring Boot codebase! And those don&#8217;t even begin to cover the implementations provided by the projects themselves, like Spring Security, Spring Data, Spring Cloud, Spring Shell, Spring Integration, and Spring Batch.
- We&#8217;e only just begun to scratch the surface here, my friends.
- Now, bear in mind that things may change in relatively minor ways in the coming weeks and months leading to spring boot 3 later this year, but conceptually, what you&#8217;ve seen here today is the future, and it&#8217;s here today.</p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2022-11-29 14:47:03 -0800
</div>
</div>
</body>
</html>